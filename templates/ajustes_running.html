<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Ajustes de Ritmo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Fuente Poppins -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

  <style>
    /* Estilos resumidos */
    * {
      box-sizing: border-box;
      font-family: 'Poppins', sans-serif;
    }
    body {
      background: #000;
      color: #fff;
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      text-align: center;
    }
    .logo {
      width: 200px;
      margin: 20px 0;
      transition: transform 0.3s, box-shadow 0.3s;
    }
    .logo:hover {
      transform: scale(1.05);
      box-shadow: 0 8px 15px rgba(255, 204, 0, 0.7);
    }

    /* Contenedor principal un poco más ancho */
    .container {
      width: 95%;            /* Ocupar casi todo el ancho */
      max-width: 800px;      /* Ahora hasta 800px */
      background: linear-gradient(145deg, #222, #111);
      text-align: center;
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 4px 20px rgba(255, 204, 0, 0.3);
      border: 2px solid #ffcc00;
      margin-bottom: 20px;
    }

    h1 {
      color: #ffcc00;
      font-size: 1.8rem;
      font-weight: 600;
      margin-bottom: 20px;
    }
    label {
      color: #bbb;
      font-weight: 600;
      display: block;
      margin-top: 10px;
      margin-bottom: 5px;
      text-align: center;
    }
    select, input[type="text"] {
      width: 80%;
      padding: 8px;
      border-radius: 10px;
      border: none;
      background: #1a1a1a;
      color: #fff;
      box-shadow: inset 4px 4px 8px rgba(0,0,0,0.5), 
                  inset -4px -4px 8px rgba(255,255,255,0.1);
      text-align: center;
      outline: none;
      margin-bottom: 10px;
    }
    select:focus, input[type="text"]:focus {
      border: 1px solid #ffd966;
      box-shadow: 0 0 8px rgba(255,204,0,0.5);
    }

    /* Slider ±10% */
    #timeSlider {
      -webkit-appearance: none;
      width: 80%;
      height: 10px;
      border-radius: 10px;
      background: #1a1a1a;
      box-shadow: inset 4px 4px 8px rgba(0,0,0,0.5), 
                  inset -4px -4px 8px rgba(255,255,255,0.1);
      outline: none;
      margin: 10px 0;
      cursor: pointer;
    }
    #timeSlider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px; 
      height: 20px;
      border-radius: 50%;
      background: #ffcc00;
      box-shadow: 0 4px 8px rgba(0,0,0,0.4),
                  inset 0 -4px 8px rgba(255,255,255,0.4);
      border: none;
      transition: transform 0.2s, box-shadow 0.3s;
    }
    #timeSlider::-webkit-slider-thumb:hover {
      transform: scale(1.2);
      box-shadow: 0 6px 12px rgba(0,0,0,0.6),
                  inset 0 -6px 12px rgba(255,255,255,0.5);
    }
    #timeSlider::-moz-range-thumb {
      width: 20px; 
      height: 20px;
      border-radius: 50%;
      background: #ffcc00;
      box-shadow: 0 4px 8px rgba(0,0,0,0.4),
                  inset 0 -4px 8px rgba(255,255,255,0.4);
      border: none;
      transition: transform 0.2s, box-shadow 0.3s;
    }
    #timeSlider::-moz-range-thumb:hover {
      transform: scale(1.2);
      box-shadow: 0 6px 12px rgba(0,0,0,0.6),
                  inset 0 -6px 12px rgba(255,255,255,0.5);
    }

    #sliderValue {
      color: #ffcc00;
      font-weight: 600;
      margin-bottom: 10px;
      display: block;
      text-align: center;
    }

    .strategy-label {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
      color: #bbb;
      font-weight: 600;
      margin-bottom: 5px;
    }
    .help-icon {
      width: 24px; 
      height: 24px;
      background: #ffcc00;
      color: #000;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-weight: bold;
      font-size: 16px;
    }
    .help-text {
      display: none;
      background: #1a1a1a;
      border: 1px solid #ffcc00;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(255,204,0,0.3);
      text-align: left;
      margin: 10px 0;
      font-size: 0.9rem;
    }

    table {
      width: 85%;
      margin-top: 20px;
      border-collapse: collapse;
      background: #1a1a1a;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 4px 10px rgba(255,204,0,0.2);
      margin-bottom: 20px;
    }
    table td {
      padding: 12px 10px;
      border-bottom: 1px solid #333;
    }
    table tr:last-child td {
      border-bottom: none;
    }

    .highlight-image {
      margin: 10px 0;
      max-width: 100%;
      border-radius: 10px;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(255,204,0,0.5);
      transition: transform 0.3s, box-shadow 0.3s;
    }
    .highlight-image:hover {
      transform: scale(1.05);
      box-shadow: 0 8px 15px rgba(255,204,0,0.7);
    }

    .button-primary {
      display: inline-block;
      margin: 10px 0;
      padding: 12px 24px;
      background: linear-gradient(135deg, #ffcc00, #e6b800);
      color: #000;
      font-weight: bold;
      border: none;
      border-radius: 10px;
      text-decoration: none;
      box-shadow: 0 4px 10px rgba(255,204,0,0.5);
      transition: all 0.3s ease-in-out;
      cursor: pointer;
    }
    .button-primary:hover {
      background: linear-gradient(135deg, #ffd966, #e6c300);
      box-shadow: 0 8px 15px rgba(255,204,0,0.7);
    }

    .km-table {
      width: 100%;
      border-collapse: collapse;
      background: #1a1a1a;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 4px 10px rgba(255,204,0,0.2);
    }
    .km-table thead {
      background-color: #ffcc00;
      color: #000;
    }
    .km-table th, .km-table td {
      text-align: center;
      padding: 10px;
      border-bottom: 1px solid #333;
    }
    .km-table tbody tr:last-child td {
      border-bottom: none;
    }
    .km-table tr:hover {
      background-color: #2a2a2a;
      transition: background-color 0.3s;
    }
  </style>
</head>
<body>
  <!-- Logo -->
  <img src="/static/logo fondo negro.png" alt="Logo" class="logo">

  <div class="container">
    <h1>Estrategia de carrera</h1>

    <!-- Inyectar datos -->
    <script>
      const estimatedTimes = {{ estimated_times|tojson }};
      console.log("Datos traídos de results:", estimatedTimes);
    </script>

    <!-- Seleccionar distancia -->
    <label for="selectDistance">Distancia:</label>
    <select id="selectDistance" onchange="fillTime(); updateAll()">
      {% for dist, data in estimated_times.items() %}
      <option value="{{ dist }}">{{ dist }} km</option>
      {% endfor %}
    </select>

    <!-- Tiempo final base -->
    <label for="inputTime">Tiempo final (HH:MM:SS):</label>
    <input
      type="text"
      id="inputTime"
      placeholder="00:16:00"
      oninput="updateAll()"
    >

    <!-- Estrategia -->
    <div class="strategy-label">
      <label for="selectStrategy">Estrategias de Ritmo:</label>
      <div class="help-icon" onclick="toggleHelpText()">?</div>
    </div>
    <div id="helpText" class="help-text">
      <p><strong>Estrategia Negativa (-1%, -2%, -3%):</strong><br>
         Comenzar más lento que el ritmo objetivo y terminar más rápido.</p>
      <p><strong>Estrategia Positiva (+1%, +2%, +3%):</strong><br>
         Comenzar más rápido y terminar más lento.</p>
      <p><strong>Estrategia Neutra:</strong><br>
         Ritmo constante en toda la prueba.</p>
    </div>
    <select id="selectStrategy" onchange="updateAll()">
      <option value="estable">Ritmo Estable</option>
      <option value="pos1">1% Positiva</option>
      <option value="pos2">2% Positiva</option>
      <option value="pos3">3% Positiva</option>
      <option value="neg1">1% Negativa</option>
      <option value="neg2">2% Negativa</option>
      <option value="neg3">3% Negativa</option>
    </select>

    <label for="timeSlider">Ajuste del tiempo (±10%):</label>
    <input
      type="range"
      id="timeSlider"
      min="0.9"
      max="1.1"
      step="0.01"
      value="1.0"
      oninput="updateAll()"
    >
    <span id="sliderValue">100%</span>

    <!-- Tabla principal (Base/Ajustado) -->
    <table>
      <tbody>
        <tr>
          <td><strong>Tiempo Final Base:</strong></td>
          <td id="baseTime">--:--:--</td>
        </tr>
        <tr>
          <td><strong>Ritmo Base (mm:ss/km):</strong></td>
          <td id="basePace">--:--</td>
        </tr>
        <tr>
          <td><strong>Tiempo Final Ajustado:</strong></td>
          <td id="adjustedTime">--:--:--</td>
        </tr>
        <tr>
          <td><strong>Ritmo Ajustado (mm:ss/km):</strong></td>
          <td id="adjustedPace">--:--</td>
        </tr>
      </tbody>
    </table>

    <!-- Imagen -->
    <a href="https://dzerotri.com/triatletas-dzero" target="_blank">
      <img src="/static/testimonios.png" alt="testimonios" class="highlight-image">
    </a>

    <!-- Tabla km a km dentro del mismo contenedor -->
    <table class="km-table" id="kmTable">
      <thead>
        <tr>
          <th>KM</th>
          <th>Tiempo Base</th>
          <th>Ritmo Base</th>
          <th>Tiempo Ajustado</th>
          <th>Ritmo Ajustado</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div style="text-align:center;">
    <a href="/" class="button-primary">CONTINUAR</a>
  </div>

  <script>
    // Evitar scroll al mover slider en móvil
    const slider = document.getElementById("timeSlider");
    slider.addEventListener("touchmove", e => e.preventDefault(), { passive: false });

    function toggleHelpText() {
      const help = document.getElementById("helpText");
      help.style.display = (help.style.display === "block") ? "none" : "block";
    }

    function fillTime() {
      const dist = document.getElementById("selectDistance").value;
      if (estimatedTimes[dist]) {
        document.getElementById("inputTime").value = estimatedTimes[dist].time;
      }
    }

    function timeToSeconds(hms) {
      const parts = hms.split(":").map(Number);
      if (parts.length === 3) {
        return parts[0]*3600 + parts[1]*60 + parts[2];
      }
      return 0;
    }
    function secondsToHMS(sec) {
      const h = Math.floor(sec/3600),
            m = Math.floor((sec%3600)/60),
            s = Math.floor(sec%60);
      return (
        String(h).padStart(2,"0")+":"+
        String(m).padStart(2,"0")+":"+
        String(s).padStart(2,"0")
      );
    }
    function secondsToPaceString(sec) {
      const minutes = Math.floor(sec/60);
      const secs = Math.floor(sec%60);
      return (
        String(minutes).padStart(2,"0")+":"+
        String(secs).padStart(2,"0")
      );
    }

    // Estrategia pos/neg con 4 cuartos
    function getSplitFactor(km, totalKm, strategy) {
      let ratio=0;
      if (strategy==="pos1") ratio =+0.01;
      if (strategy==="pos2") ratio =+0.02;
      if (strategy==="pos3") ratio =+0.03;
      if (strategy==="neg1") ratio =-0.01;
      if (strategy==="neg2") ratio =-0.02;
      if (strategy==="neg3") ratio =-0.03;

      if (strategy==="estable") {
        return 1.0;
      }
      const quarter = totalKm/4.0;
      let phaseAdjustments=[1,1,1,1];
      if (strategy.startsWith("pos")) {
        const absR=Math.abs(ratio);
        phaseAdjustments=[
          1.0 - absR*0.5,
          1.0 - absR*0.2,
          1.0 + absR*0.2,
          1.0 + absR*0.5
        ];
      } else if (strategy.startsWith("neg")) {
        const absR=Math.abs(ratio);
        phaseAdjustments=[
          1.0 + absR*0.5,
          1.0 + absR*0.2,
          1.0 - absR*0.2,
          1.0 - absR*0.5
        ];
      }
      if (km>3*quarter) return phaseAdjustments[3];
      else if (km>2*quarter) return phaseAdjustments[2];
      else if (km>quarter)   return phaseAdjustments[1];
      else                   return phaseAdjustments[0];
    }

    // Suma total con parte decimal
    function calcTotalSeconds(distance, basePaceSec, strategy, factor) {
      const fullKm = Math.floor(distance);
      const leftover = distance - fullKm;
      let totalSec = 0;

      // 1) Kms enteros
      for (let km = 1; km <= fullKm; km++) {
        const splitF = getSplitFactor(km, distance, strategy);
        totalSec += (basePaceSec * factor) * splitF;
      }
      // 2) Tramo decimal
      if (leftover > 0) {
        const partialIndex = fullKm + leftover;
        const splitF = getSplitFactor(partialIndex, distance, strategy);
        totalSec += (basePaceSec * factor) * splitF * leftover;
      }
      return totalSec;
    }

    // Construir splits (base/ajustado) con parte decimal
    function buildKmSplits(distance, basePaceSec, strategy, factor, isBase=false) {
      let results = [];
      let accumulated = 0;
      const fullKm = Math.floor(distance);
      const leftover = distance - fullKm;

      for (let km = 1; km <= fullKm; km++) {
        const sFactor = isBase 
          ? getSplitFactor(km, distance, "estable") 
          : getSplitFactor(km, distance, strategy);

        const paceSec = (basePaceSec * (isBase ? 1 : factor)) * sFactor;
        accumulated += paceSec;

        results.push({
          kmDisplay: km.toString(),
          accumulated: secondsToHMS(Math.round(accumulated)),
          paceString: secondsToPaceString(paceSec)
        });
      }
      // Parte decimal
      if (leftover > 0) {
        const partialIndex = fullKm + leftover;
        const sFactor = isBase
          ? getSplitFactor(partialIndex, distance, "estable")
          : getSplitFactor(partialIndex, distance, strategy);

        const paceSec = (basePaceSec * (isBase ? 1 : factor)) * sFactor * leftover;
        accumulated += paceSec;

        results.push({
          kmDisplay: partialIndex.toFixed(3),
          accumulated: secondsToHMS(Math.round(accumulated)),
          paceString: secondsToPaceString(
            (basePaceSec * (isBase ? 1 : factor)) * sFactor
          )
        });
      }
      return results;
    }

    function updateAll() {
      // Rellenar tiempo base si procede
      fillTime();

      const distNum = parseFloat(document.getElementById("selectDistance").value) || 5;
      const userTime = document.getElementById("inputTime").value || "00:16:00";
      const userTimeSec = timeToSeconds(userTime);

      const basePaceSec = userTimeSec / distNum;

      document.getElementById("baseTime").textContent = userTime;
      document.getElementById("basePace").textContent = secondsToPaceString(basePaceSec);

      const factor = parseFloat(document.getElementById("timeSlider").value);
      document.getElementById("sliderValue").textContent = (factor*100).toFixed(0) + "%";

      const strategy = document.getElementById("selectStrategy").value;

      // Tiempo final Ajustado
      const totalAdjustedSec = calcTotalSeconds(distNum, basePaceSec, strategy, factor);
      document.getElementById("adjustedTime").textContent = secondsToHMS(Math.round(totalAdjustedSec));
      document.getElementById("adjustedPace").textContent = secondsToPaceString(totalAdjustedSec / distNum);

      // Splits base y ajustado
      const baseSplits = buildKmSplits(distNum, basePaceSec, strategy, factor, true);
      const adjSplits  = buildKmSplits(distNum, basePaceSec, strategy, factor, false);

      const tbody = document.getElementById("kmTable").querySelector("tbody");
      tbody.innerHTML = "";

      const maxLen = Math.max(baseSplits.length, adjSplits.length);
      for (let i=0; i<maxLen; i++) {
        const b = baseSplits[i];
        const a = adjSplits[i];
        const kmLabel = b ? b.kmDisplay : (a ? a.kmDisplay : "");
        const baseTimeAcc = b ? b.accumulated : "";
        const basePace    = b ? b.paceString  : "";
        const adjTimeAcc  = a ? a.accumulated : "";
        const adjPace     = a ? a.paceString  : "";

        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${kmLabel}</td>
          <td>${baseTimeAcc}</td>
          <td>${basePace}</td>
          <td>${adjTimeAcc}</td>
          <td>${adjPace}</td>
        `;
        tbody.appendChild(row);
      }
    }

    // Al cargar la página
    window.onload = () => {
      updateAll();
    };
  </script>
</body>
</html>
